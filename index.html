<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ChronaX ‚Äî Timestamp Registry MVP</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 30px auto;
            padding: 20px;
            background: #f7f7f7;
        }
        h1 {
            text-align: center;
        }
        .box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        #hashOutput, #verifyOutput {
            word-break: break-all;
            background: #e9e9e9;
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px;
        }
        button {
            padding: 10px 15px;
            border: none;
            background: black;
            color: white;
            border-radius: 8px;
            cursor: pointer;
        }
        button:hover {
            opacity: 0.85;
        }
    </style>
</head>

<body>

<h1>ChronaX ‚Äî Timestamp Registry (MVP)</h1>

<!-- ========================= -->
<!--  HASH GENERATOR SECTION  -->
<!-- ========================= -->
<div class="box">
    <h2>1. Generate Hash</h2>

    <input type="file" id="fileInput"><br><br>
    <button onclick="generateHash()">Generate SHA-256</button>

    <div id="hashOutput"></div>
</div>

<!-- ========================= -->
<!--  REGISTER SECTION        -->
<!-- ========================= -->
<div class="box">
    <h2>2. Register on Blockchain</h2>

    <button onclick="registerHash()">Register Hash On-Chain</button>
    <div id="registerStatus"></div>
</div>

<!-- ========================= -->
<!--  VERIFY SECTION          -->
<!-- ========================= -->
<div class="box">
    <h2>3. Verify Hash</h2>

    <input style="width:100%" id="verifyHashInput" placeholder="Paste hash here"><br><br>
    <button onclick="verifyHash()">Verify</button>

    <div id="verifyOutput"></div>
</div>

<script>
/* ------------------------------
   CONFIGURATION
--------------------------------*/
const CONTRACT_ADDRESS = "YOUR_DEPLOYED_CONTRACT_ADDRESS";
const ABI = [
    {
        "inputs":[{"internalType":"bytes32","name":"docHash","type":"bytes32"}],
        "name":"register",
        "outputs":[],
        "stateMutability":"nonpayable",
        "type":"function"
    },
    {
        "inputs":[{"internalType":"bytes32","name":"docHash","type":"bytes32"}],
        "name":"isRegistered",
        "outputs":[{"internalType":"bool","name":"","type":"bool"}],
        "stateMutability":"view",
        "type":"function"
    },
    {
        "inputs":[{"internalType":"bytes32","name":"docHash","type":"bytes32"}],
        "name":"getRecord",
        "outputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],
        "stateMutability":"view",
        "type":"function"
    }
];

let lastGeneratedHash = null;

/* ------------------------------
   1. Generate Hash
--------------------------------*/
async function generateHash() {
    const file = document.getElementById("fileInput").files[0];
    const output = document.getElementById("hashOutput");

    if (!file) {
        output.innerHTML = "<b>Please select a file.</b>";
        return;
    }

    const arrayBuffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest("SHA-256", arrayBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2,"0")).join("");

    lastGeneratedHash = hashHex;

    output.innerHTML = `<b>Hash:</b><br>${hashHex}`;
}

/* ------------------------------
   2. Register Hash On-Chain
--------------------------------*/
async function registerHash() {
    if (!lastGeneratedHash) {
        alert("Generate a hash first!");
        return;
    }

    if (!window.ethereum) {
        alert("MetaMask required!");
        return;
    }

    const provider = new ethers.BrowserProvider(window.ethereum);
    const signer = await provider.getSigner();

    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

    const hashBytes32 = "0x" + lastGeneratedHash;

    const status = document.getElementById("registerStatus");
    status.innerHTML = "‚è≥ Waiting for wallet confirmation...";

    try {
        const tx = await contract.register(hashBytes32);

        status.innerHTML = "‚è≥ Transaction pending...";
        await tx.wait();

        status.innerHTML = "üéâ Registered Successfully!<br>Tx Hash: " + tx.hash;

    } catch (err) {
        status.innerHTML = "‚ùå Error: " + err.message;
    }
}

/* ------------------------------
   3. Verify Hash
--------------------------------*/
async function verifyHash() {
    const input = document.getElementById("verifyHashInput").value.trim();
    const output = document.getElementById("verifyOutput");

    if (!input) return;

    const provider = new ethers.JsonRpcProvider(
        "https://rpc.ankr.com/eth_sepolia" // default, bisa kamu ganti
    );

    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

    const hashBytes32 = "0x" + input;

    try {
        const [owner, timestamp] = await contract.getRecord(hashBytes32);

        if (timestamp == 0) {
            output.innerHTML = "‚ùå Hash not registered.";
        } else {
            output.innerHTML = `
                ‚úî Registered<br><br>
                <b>Owner:</b> ${owner}<br>
                <b>Timestamp:</b> ${new Date(timestamp * 1000).toLocaleString()}
            `;
        }

    } catch (err) {
        output.innerHTML = "‚ùå Error: " + err.message;
    }
}
</script>

</body>
  </html>
